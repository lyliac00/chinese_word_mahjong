<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ›æ„æ–‡å­—éº»å°†</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --bg: #2c3e50; --card-bg: #ecf0f1; --accent: #e74c3c; --highlight: #2ecc71; --selected-btn: #f39c12; }
        body { margin: 0; padding: 0; font-family: 'PingFang SC', sans-serif; background: var(--bg); color: white; overflow-x: hidden; user-select: none;}
        
        #app { max-width: 600px; margin: 0 auto; padding: 10px; display: flex; flex-direction: column; height: 100vh; }
        
        header { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }
        
        /* ç©å®¶å¡ç‰‡ */
        #players-area { display: flex; justify-content: space-around; margin: 10px 0; }
        .player-card { background: rgba(255,255,255,0.1); padding: 5px; border-radius: 5px; text-align: center; font-size: 0.8em; position: relative; width: 22%; transition: all 0.3s;}
        .player-card.active { border: 2px solid #f1c40f; box-shadow: 0 0 10px #f1c40f; transform: scale(1.05); }
        .player-card.winner { border: 2px solid #2ecc71; background: rgba(46, 204, 113, 0.3); }
        .dealer-tag { position: absolute; top: -8px; right: -8px; background: #e67e22; color: white; font-size: 0.7em; padding: 2px 4px; border-radius: 3px; z-index: 10;}
        
        /* æ¡Œé¢ */
        #board { flex: 1; display: flex; flex-direction: column; justify-content: center; position: relative; }
        #discard-pile { 
            height: 150px; background: rgba(0,0,0,0.2); border-radius: 8px; margin: 10px 0; padding: 10px; 
            display: flex; flex-wrap: wrap; align-content: flex-start; overflow-y: auto;
        }
        .tile-sm { width: 24px; height: 32px; background: #bdc3c7; color: #333; margin: 2px; display: flex; align-items: center; justify-content: center; border-radius: 3px; font-size: 0.8em;}

        /* æ‰‹ç‰ŒåŒº */
        #my-area { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 10px; margin-top: auto; }
        #hand { display: flex; flex-wrap: wrap; justify-content: center; min-height: 60px; touch-action: none; }
        
        /* ç‰Œæ ·å¼ */
        .tile { 
            width: 38px; height: 52px; background: var(--card-bg); color: #2c3e50; 
            margin: 4px; border-radius: 4px; display: flex; align-items: center; justify-content: center; 
            font-size: 1.3em; font-weight: bold; cursor: pointer; position: relative;
            box-shadow: 0 4px 0 #95a5a6; 
        }
        .tile:active { transform: translateY(3px); box-shadow: 0 1px 0 #95a5a6; }
        .tile.selected { border: 3px solid #e74c3c; transform: translateY(-8px); z-index: 10; }
        .tile.new-tile { border: 2px solid var(--highlight); box-shadow: 0 0 10px var(--highlight); }
        .sortable-ghost { opacity: 0.4; background: #f1c40f; } 
        
        /* UIç»„ä»¶ */
        #controls { margin-top: 10px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 8px; }
        button { padding: 12px 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 1em; }
        .btn-discard { background: #e74c3c; }
        .btn-pitch { background: #2ecc71; }
        .btn-draw { background: #3498db; }
        .btn-eat { background: #9b59b6; }
        .btn-ready { background: #f1c40f; color: #333; width: 100%; font-size: 1.2em; margin-top: 20px;}
        .btn-rules { background: #7f8c8d; width: 100%; margin-top: 10px; }
        button:disabled { background: #95a5a6; opacity: 0.5; cursor: default; }
        .player-count-btn { background: #34495e; color: #ccc; margin: 0 5px; width: 60px; }
        .player-count-btn.active { background: var(--selected-btn); color: white; transform: scale(1.1); box-shadow: 0 0 10px var(--selected-btn); }

        /* æ¨¡æ€çª— */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; }
        #rules-modal { z-index: 300; }
        .modal-content { background: #34495e; padding: 25px; border-radius: 10px; width: 85%; max-width: 400px; text-align: center; }
        #flash-overlay {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: #f1c40f; padding: 20px 40px; border-radius: 10px;
            font-size: 1.5em; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 500; text-align: center; width: 80%;
        }

        #login-screen { position: absolute; top:0; left:0; width:100%; height:100%; background:#2c3e50; z-index:200; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        input[type="text"] { padding: 10px; font-size: 1.2em; text-align: center; margin-bottom: 20px; border-radius: 5px; border: none;}
        input[type=range] { width: 80%; margin: 20px 0; }
        #pitch-display { display: flex; flex-wrap: wrap; justify-content: center; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin: 15px 0; }

        /* --- ç»“ç®—ç•Œé¢æ ·å¼ --- */
        #game-over-screen { position: absolute; top:0; left:0; width:100%; height:100%; background:#2c3e50; z-index:400; display:none; flex-direction:column; align-items:center; padding: 20px; box-sizing: border-box; overflow-y: auto;}
        .rank-card { width: 100%; max-width: 500px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 15px; padding: 15px; }
        .rank-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; margin-bottom: 10px; }
        .rank-title { font-size: 1.2em; font-weight: bold; color: #f1c40f; }
        .history-row { display: flex; flex-wrap: wrap; margin-top: 5px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 5px; }
        .history-row .tile-xs { width: 20px; height: 28px; background: #ecf0f1; color: #2c3e50; margin: 1px; display: flex; align-items: center; justify-content: center; border-radius: 2px; font-size: 0.7em; font-weight: bold;}
    </style>
</head>
<body>

    <div id="flash-overlay"></div>

    <div id="login-screen">
        <h1 style="font-size: 2.5em; margin-bottom: 10px;">ğŸ€„ åˆ›æ„æ–‡å­—éº»å°†</h1>
        <p style="color:#bdc3c7; margin-bottom: 30px;">æ‹¼å¥ Â· è„‘æ´ Â· å˜´ç‚®</p>
        <input type="text" id="username" placeholder="è¾“å…¥æ˜µç§°" maxlength="6">
        <div style="width: 220px;">
            <button onclick="joinGame()" class="btn-ready">è¿›å…¥æˆ¿é—´</button>
            <button onclick="showRules()" class="btn-rules">ğŸ“œ æ¸¸æˆè§„åˆ™</button>
        </div>
    </div>

    <div id="game-over-screen">
        <h1 style="color: #f1c40f; margin-bottom: 20px;">ğŸ† æœ€ç»ˆæˆ˜ç»© ğŸ†</h1>
        <div id="rank-list" style="width:100%"></div>
        <button onclick="location.reload()" class="btn-ready" style="margin-top:20px; max-width: 200px;">è¿”å›å¤§å…</button>
    </div>

    <div id="rules-modal" class="modal">
        <div class="modal-content" style="text-align: left; max-height: 70vh; overflow-y: auto; color:#ecf0f1;">
            <h2 style="text-align: center;">ğŸ“œ è§„åˆ™è¯´æ˜</h2>
            <p>1. <strong>æµç¨‹ï¼š</strong>æ¯äºº13å¼ ç‰Œã€‚è½®æµæ‘¸ç‰Œæˆ–åƒç‰Œï¼Œå‡‘é½14å¼ ã€‚</p>
            <p>2. <strong>èƒ¡ç‰Œï¼š</strong>ç‚¹å‡»ã€èƒ¡ç‰Œã€‘å¹¶å£è¿°ä½ çš„åˆ›æ„æ‹¼å¥ã€‚å…¶ä½™ç©å®¶è¯„åˆ†ã€‚</p>
            <p>3. <strong>è¯„åˆ†ï¼š</strong>æ€»åˆ†è¶…è¿‡åŠæ ¼çº¿å³èƒ¡ç‰Œã€‚åŠæ ¼çº¿ = (äººæ•°-1) Ã— 5ã€‚</p>
            <p>4. <strong>æƒ©ç½šï¼š</strong>èƒ¡ç‰Œå¤±è´¥æ‰£5åˆ†ï¼Œå¹¶å¼ºåˆ¶å‡ºç‰Œã€‚</p>
            <br>
            <button onclick="hideRules()" style="width:100%; background:#e74c3c;">å…³é—­</button>
        </div>
    </div>

    <div id="vote-modal" class="modal">
        <div class="modal-content">
            <h2 id="vote-title">ç©å®¶æ­£åœ¨è·¯æ¼”</h2>
            <div id="pitch-display"></div>
            <div id="voting-controls">
                <p>è¯·æ‰“åˆ† (0-10)</p>
                <div style="font-size: 2em; color: #f1c40f;" id="vote-val-display">5</div>
                <input type="range" id="vote-range" min="0" max="10" value="5" oninput="document.getElementById('vote-val-display').innerText = this.value">
                <button onclick="submitVote()" class="btn-pitch" style="width:80%">ç¡®è®¤åˆ†æ•°</button>
            </div>
            <div id="waiting-vote-msg" style="display:none; color:#f1c40f; margin-top:20px;">
                æ­£åœ¨ç­‰å¾…è¯„åˆ†...<br>è¯·æŠ“ç´§æ—¶é—´è§£é‡Šä½ çš„åˆ›æ„ï¼
            </div>
        </div>
    </div>

    <div id="app" style="display:none;">
        <header>
            <div id="room-info">ç­‰å¾…å¼€å§‹...</div>
            <div style="font-size:0.8em; color:#f1c40f;" id="deck-info">ç‰Œå±±: 136</div>
        </header>

        <div id="players-area"></div>

        <div id="board">
            <div style="font-size:0.8em; color:#aaa; margin-left:10px;">å¼ƒç‰Œå †:</div>
            <div id="discard-pile"></div>
        </div>

        <div id="lobby-controls" style="text-align: center; margin-bottom: 20px;">
            <h3>è®¾ç½®äººæ•°</h3>
            <div>
                <button id="btn-p2" class="player-count-btn" onclick="setPlayers(2)">2äºº</button>
                <button id="btn-p3" class="player-count-btn" onclick="setPlayers(3)">3äºº</button>
                <button id="btn-p4" class="player-count-btn active" onclick="setPlayers(4)">4äºº</button>
            </div>
            <button onclick="sendReady()" class="btn-ready">å‡†å¤‡ / å¼€å§‹</button>
        </div>

        <div id="my-area" style="display:none;">
            <div id="controls">
                <button onclick="sendAction('draw')" id="btn-draw" class="btn-draw" style="display:none;">ğŸ– æ‘¸ç‰Œ</button>
                <button onclick="sendAction('eat')" id="btn-eat" class="btn-eat" style="display:none;">ğŸ¥£ åƒ</button>
                <button onclick="actionDiscard()" class="btn-discard" id="btn-discard" disabled>ğŸ—‘ å‡ºç‰Œ</button>
                <button onclick="actionPitch()" class="btn-pitch" id="btn-pitch" disabled>âœ¨ èƒ¡ç‰Œ</button>
            </div>
            <p style="font-size:0.8em; text-align:center; opacity:0.6; margin: 5px 0;">æ‹–æ‹½æ’åº Â· ç‚¹å‡»é€‰ä¸­</p>
            <div id="hand"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myId = null;
        let myHand = [];
        let newTileIndex = -1; 
        let selectedTileIndex = null;
        let sortableInstance = null;

        function joinGame() {
            const name = document.getElementById('username').value || 'ç©å®¶';
            socket.emit('join', name);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
        }
        function setPlayers(n) { socket.emit('setPlayerCount', n); }
        function sendReady() { socket.emit('ready'); }
        function showRules() { document.getElementById('rules-modal').style.display = 'flex'; }
        function hideRules() { document.getElementById('rules-modal').style.display = 'none'; }
        
        function showFlash(text) {
            const el = document.getElementById('flash-overlay');
            el.innerText = text;
            el.style.opacity = 1;
            setTimeout(() => { el.style.opacity = 0; }, 2500);
        }

        socket.on('joined', (data) => { myId = data.id; });
        socket.on('msg', (msg) => { });
        socket.on('flashMessage', (msg) => { showFlash(msg); });

        socket.on('settingsUpdate', (settings) => {
            [2, 3, 4].forEach(n => {
                const btn = document.getElementById(`btn-p${n}`);
                if (n === settings.playerCount) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        });

        socket.on('gameStart', () => {
            document.getElementById('lobby-controls').style.display = 'none';
            document.getElementById('my-area').style.display = 'block';
        });

        socket.on('handUpdate', (data) => {
            myHand = data.hand;
            newTileIndex = data.newTileIndex;
            renderHand();
        });

        socket.on('turnWaitAction', (data) => {
            document.getElementById('btn-draw').style.display = 'inline-block';
            document.getElementById('btn-discard').disabled = true;
            document.getElementById('btn-pitch').disabled = true;

            const btnEat = document.getElementById('btn-eat');
            if (data.canEat) {
                btnEat.style.display = 'inline-block';
                btnEat.innerText = `ğŸ¥£ åƒ [${data.lastDiscard}]`;
            } else {
                btnEat.style.display = 'none';
            }
        });

        socket.on('updateGame', (state) => {
            // æ¸¸æˆç»“æŸå¤„ç†
            if (state.status === 'END') {
                renderGameOver(state.players);
                document.getElementById('game-over-screen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
                return;
            }

            if (state.status !== 'VOTING') {
                document.getElementById('vote-modal').style.display = 'none';
                document.getElementById('waiting-vote-msg').style.display = 'none';
                document.getElementById('voting-controls').style.display = 'block';
            }
            
            if (state.status === 'LOBBY') {
                [2, 3, 4].forEach(n => {
                    const btn = document.getElementById(`btn-p${n}`);
                    if (n === state.settings.playerCount) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
            }

            renderPlayers(state.players);
            renderDiscard(state.discardPile);
            
            if(state.status === 'PLAYING') {
                document.getElementById('room-info').innerText = state.roundInfo.text;
                document.getElementById('deck-info').innerText = `ç‰Œå±±: ${state.roundInfo.deckCount}`;
                
                const me = state.players.find(p => p.id === myId);
                const isDrawPhase = document.getElementById('btn-draw').style.display !== 'none';
                
                if (me && me.isTurn && !isDrawPhase) {
                    document.getElementById('btn-discard').disabled = false;
                    document.getElementById('btn-pitch').disabled = false;
                    if (selectedTileIndex !== null) {
                         document.getElementById('btn-discard').innerText = "ğŸ—‘ å‡ºç‰Œ";
                    } else {
                         document.getElementById('btn-discard').innerText = "è¯·é€‰ç‰Œ";
                    }
                } else if (!me.isTurn) {
                    document.getElementById('btn-draw').style.display = 'none';
                    document.getElementById('btn-eat').style.display = 'none';
                    document.getElementById('btn-discard').disabled = true;
                    document.getElementById('btn-pitch').disabled = true;
                }
            }
        });

        socket.on('voteResult', (data) => {
            document.getElementById('vote-modal').style.display = 'none';
            if (!data.success && myId === data.pitcherId) {
                setTimeout(() => alert("åˆ›æ„æœªè·è®¤å¯ï¼Œæ‰£5åˆ†ã€‚è¯·æ‰“å‡ºä¸€å¼ ç‰Œã€‚"), 500);
            }
        });

        socket.on('startVoting', (data) => {
            const modal = document.getElementById('vote-modal');
            const display = document.getElementById('pitch-display');
            const ctrls = document.getElementById('voting-controls');
            const waitMsg = document.getElementById('waiting-vote-msg');

            modal.style.display = 'flex';
            document.getElementById('vote-title').innerText = `${data.pitcherName} æ­£åœ¨è·¯æ¼”`;
            
            display.innerHTML = '';
            data.pitcherHand.forEach(char => {
                const s = document.createElement('div');
                s.className = 'tile';
                s.innerText = char;
                display.appendChild(s);
            });

            if (data.pitcherId === myId) {
                ctrls.style.display = 'none';
                waitMsg.style.display = 'block';
            } else {
                ctrls.style.display = 'block';
                waitMsg.style.display = 'none';
                document.getElementById('vote-range').value = 5;
                document.getElementById('vote-val-display').innerText = 5;
            }
        });

        // --- æ¸²æŸ“ç»“ç®—ç•Œé¢ ---
        function renderGameOver(players) {
            const list = document.getElementById('rank-list');
            list.innerHTML = '';
            
            // æŒ‰åˆ†æ•°æ’åº
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
            
            sortedPlayers.forEach((p, idx) => {
                const card = document.createElement('div');
                card.className = 'rank-card';
                if (idx === 0) card.style.border = '2px solid #f1c40f'; // å† å†›é‡‘è¾¹
                
                let medal = '';
                if(idx === 0) medal = 'ğŸ¥‡';
                else if(idx === 1) medal = 'ğŸ¥ˆ';
                else if(idx === 2) medal = 'ğŸ¥‰';

                let historyHTML = '';
                if (p.history && p.history.length > 0) {
                    p.history.forEach(hand => {
                        let tilesHTML = hand.map(t => `<div class="tile-xs">${t}</div>`).join('');
                        historyHTML += `<div class="history-row">${tilesHTML}</div>`;
                    });
                } else {
                    historyHTML = '<div style="font-size:0.8em; color:#95a5a6; margin-top:5px;">æœ¬å±€æ— èƒ¡ç‰Œè®°å½•</div>';
                }

                card.innerHTML = `
                    <div class="rank-header">
                        <div class="rank-title">${medal} ${p.name}</div>
                        <div style="font-size:1.5em; font-weight:bold;">${p.score}åˆ†</div>
                    </div>
                    <div style="font-size:0.9em; color:#bdc3c7;">èƒ¡ç‰Œè®°å½•ï¼š</div>
                    ${historyHTML}
                `;
                list.appendChild(card);
            });
        }

        function renderPlayers(players) {
            const container = document.getElementById('players-area');
            container.innerHTML = '';
            players.forEach(p => {
                const div = document.createElement('div');
                div.className = `player-card ${p.isTurn ? 'active' : ''} ${p.hasWon ? 'winner' : ''}`;
                div.innerHTML = `
                    ${p.isDealer ? '<span class="dealer-tag">åº„</span>' : ''}
                    <div>${p.name}</div>
                    <div style="font-weight:bold; color:#f1c40f">${p.score}</div>
                    <div style="font-size:0.7em; color:#bdc3c7">${p.handCount}å¼ </div>
                `;
                container.appendChild(div);
            });
        }

        function renderDiscard(pile) {
            const div = document.getElementById('discard-pile');
            div.innerHTML = '';
            pile.forEach(t => {
                const s = document.createElement('div');
                s.className = 'tile-sm';
                s.innerText = t;
                div.appendChild(s);
            });
            div.scrollTop = div.scrollHeight;
        }

        function renderHand() {
            const handDiv = document.getElementById('hand');
            handDiv.innerHTML = '';
            myHand.forEach((tile, index) => {
                const el = document.createElement('div');
                el.className = 'tile';
                if (index === newTileIndex) el.classList.add('new-tile');
                if (index === selectedTileIndex) el.classList.add('selected');
                el.innerText = tile;
                el.setAttribute('data-id', index); 
                el.onclick = () => {
                    if (selectedTileIndex === index) { selectedTileIndex = null; } 
                    else { selectedTileIndex = index; }
                    renderHand(); 
                    const btnDiscard = document.getElementById('btn-discard');
                    if(!btnDiscard.disabled) {
                         btnDiscard.innerText = selectedTileIndex !== null ? "ğŸ—‘ å‡ºç‰Œ" : "è¯·é€‰ç‰Œ";
                    }
                };
                handDiv.appendChild(el);
            });

            if (!sortableInstance) {
                sortableInstance = new Sortable(handDiv, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    delay: 100,
                    delayOnTouchOnly: true,
                    onEnd: function (evt) {
                        const item = myHand.splice(evt.oldIndex, 1)[0];
                        myHand.splice(evt.newIndex, 0, item);
                        if (evt.oldIndex === newTileIndex) newTileIndex = -1;
                        else if (newTileIndex > evt.oldIndex && newTileIndex <= evt.newIndex) newTileIndex--;
                        else if (newTileIndex < evt.oldIndex && newTileIndex >= evt.newIndex) newTileIndex++;
                        else if (newTileIndex === evt.newIndex) newTileIndex = evt.newIndex;
                        selectedTileIndex = null;
                        renderHand();
                    },
                });
            }
        }

        function sendAction(type) {
            socket.emit('playerAction', type);
            document.getElementById('btn-draw').style.display = 'none';
            document.getElementById('btn-eat').style.display = 'none';
        }
        function actionDiscard() {
            if (selectedTileIndex === null) { showFlash('è¯·å…ˆç‚¹é€‰ä¸€å¼ ç‰Œ'); return; }
            socket.emit('discard', selectedTileIndex);
            selectedTileIndex = null;
        }
        function actionPitch() { socket.emit('pitch', { hand: myHand }); }
        function submitVote() {
            const val = document.getElementById('vote-range').value;
            socket.emit('submitVote', val);
            document.getElementById('vote-modal').style.display = 'none';
        }
    </script>
</body>
</html>
